<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Search - Lusaka</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1580587771525-78b9dba3b914?auto=format&fit=crop&w=1740&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: black;
    }

    .glass {
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      background-color: rgba(255, 255, 255, 0.25);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .fixed-map {
      position: sticky;
      top: 0;
      height: 100vh;
    }

    @media (max-width: 1024px) {
      .responsive-container {
        flex-direction: column;
        height: auto;
      }

      .responsive-half {
        width: 100% !important;
      }

      .fixed-map {
        position: relative;
        height: 350px !important;
      }

      .glass {
        padding: 1rem;
        border-radius: 0;
      }
    }

    @media (max-width: 768px) {
      h2.text-5xl {
        font-size: 2rem;
      }

      .glass p,
      .glass input,
      .glass button {
        font-size: 1rem;
      }

      .floating-menu {
        bottom: 1rem;
        right: 1rem;
        padding: 0.5rem;
        gap: 0.5rem;
      }

      .floating-menu a {
        font-size: 0.9rem;
      }

      .fixed-map {
        height: 300px !important;
      }
    }

    @media (max-width: 480px) {
      .glass {
        padding: 1rem 0.75rem;
      }

      .glass h3 {
        font-size: 1.2rem;
      }

      .glass p,
      .glass button {
        font-size: 0.85rem;
      }

      .fixed-map {
        height: 250px !important;
      }
    }
  </style>
</head>

<body class="font-sans bg-opacity-30 text-black text-[1.05rem]">

  <!-- Floating Menu -->
  <div class="fixed bottom-4 right-4 z-50 bg-white bg-opacity-70 backdrop-blur-md shadow-xl rounded-xl p-4 flex flex-col gap-2 floating-menu">
    <a href="index.html" class="text-blue-700 hover:underline font-semibold">Home</a>
    <a href="listings.html" class="text-blue-700 hover:underline font-semibold">Listings</a>
    <a href="contact.html" class="text-blue-700 hover:underline font-semibold">Contact</a>
  </div>

  <!-- Main Content -->
  <div class="flex lg:flex-row responsive-container">

    <!-- Map Section -->
    <div class="w-full lg:w-1/2 responsive-half fixed-map z-10">
      <div id="map" class="h-full rounded-none lg:rounded-r-3xl shadow-2xl"></div>
    </div>

    <!-- Listings Section -->
    <div class="w-full lg:w-1/2 p-6 lg:p-8 overflow-y-auto glass responsive-half" style="max-height: 100vh;">
      <h2 class="text-4xl lg:text-5xl font-bold mb-3 text-blue-900">Find Your Home</h2>
      <p class="mb-4 text-sm text-blue-700">Homes for rent in Lusaka, Zambia</p>

      <!-- Search Input -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
        <input id="searchInput" type="text" placeholder="Search by title or location..."
          class="w-full bg-white bg-opacity-60 backdrop-blur-md border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 text-black" />
        <button id="searchButton"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition w-full sm:w-auto">Search</button>
      </div>

      <!-- Listings Count -->
      <div id="listingCount" class="mb-4 text-gray-800 font-semibold"></div>

      <!-- Listings -->
      <div id="properties" class="space-y-6"></div>
    </div>
  </div>

  <!-- Firebase & Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCA6oxno4zHhbBgOB7Y5EpmR3fMl9Y8SX4",
      authDomain: "live-281b2.firebaseapp.com",
      projectId: "live-281b2",
      storageBucket: "live-281b2.appspot.com",
      messagingSenderId: "138809616254",
      appId: "1:138809616254:web:bc91cd4b22df745b86352f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const propertiesContainer = document.getElementById("properties");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const listingCount = document.getElementById("listingCount");

    let allListings = [];
    let markerMap = {};
    const map = L.map('map').setView([-15.3875, 28.3228], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    async function fetchListings() {
      const snapshot = await db.collection("listings").get();
      allListings = snapshot.docs
        .map((doc, index) => ({
          id: doc.id,
          isLatest: index < 3, // Top 3 treated as 'newest'
          ...doc.data()
        }))
        .filter(l => l.status && l.status.toLowerCase() === 'vacant');
      renderListings(allListings);
      plotMarkers(allListings);
    }

    function renderListings(listings) {
      propertiesContainer.innerHTML = listings.length ? "" : "<p class='text-black'>No listings found.</p>";
      listingCount.textContent = `${listings.length} listing${listings.length !== 1 ? 's' : ''} found`;

      listings.forEach(l => {
        const div = document.createElement("div");
        div.className = "p-4 bg-white bg-opacity-10 rounded-xl shadow-lg cursor-pointer hover:bg-opacity-20 transition text-black relative";

        const imageHtml = l.imageUrl
          ? `<img src="${l.imageUrl}" alt="${l.title}" class="w-full h-48 object-cover rounded mb-3 border border-white shadow-md" />`
          : '';

        const latestBadge = l.isLatest
          ? `<span class="absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded shadow">Latest</span>`
          : '';

        div.innerHTML = `
          ${latestBadge}
          ${imageHtml}
          <h3 class="text-2xl font-bold text-blue-900">${l.title}</h3>
          <p class="text-sm mb-1">${l.description}</p>
          <p class="font-semibold">Location: ${l.location}</p>
          <p class="font-semibold">Price: ZMW ${l.price}</p>
          <p class="font-semibold">Bedrooms: ${l.bedrooms}</p>
          <p class="font-semibold text-sm text-green-600">Status: ${l.status || "Unknown"}</p>
          <button onclick="event.stopPropagation(); handleInterest('${l.id}')" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            I'm Interested
          </button>
        `;

        div.addEventListener('click', () => {
          if (l.lat && l.lng) {
            map.setView([l.lat, l.lng], 15);
            if (markerMap[l.id]) {
              markerMap[l.id].openPopup();
            }
          }
        });
        propertiesContainer.appendChild(div);
      });
    }

    function plotMarkers(listings) {
      markerMap = {};
      listings.forEach(l => {
        if (l.lat && l.lng) {
          const marker = L.marker([l.lat, l.lng]).addTo(map)
            .bindPopup(`<b>${l.title}</b><br>ZMW ${l.price}`);
          markerMap[l.id] = marker;
        }
      });
    }

    function searchByLocation() {
      const query = searchInput.value.toLowerCase();
      const filtered = allListings.filter(l =>
        (l.location && l.location.toLowerCase().includes(query)) ||
        (l.title && l.title.toLowerCase().includes(query))
      );
      renderListings(filtered);
    }

    async function handleInterest(id) {
      const user = auth.currentUser;
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const phone = prompt("Enter your phone number:");
      if (!phone) return;

      const listing = allListings.find(l => l.id === id);
      if (!listing) {
        alert("Listing not found.");
        return;
      }

      db.collection("interests").add({
        listingId: id,
        landlordId: listing.landlordId || null,
        userId: user.uid,
        phone,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => alert("Interest submitted!"))
        .catch(err => alert("Error saving interest."));
    }

    searchButton.addEventListener("click", searchByLocation);
    fetchListings();
  </script>
</body>
</html>
